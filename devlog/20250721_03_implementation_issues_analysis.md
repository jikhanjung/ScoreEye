# ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ë°”ë¼ì¸ ê²€ì¶œ êµ¬í˜„ ë¬¸ì œ ë¶„ì„

**ì‘ì„±ì¼**: 2025ë…„ 7ì›” 21ì¼  
**ë¬¸ì„œ ëª©ì **: ìƒˆë¡œ êµ¬í˜„ëœ ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ë°”ë¼ì¸ ê²€ì¶œ ì•Œê³ ë¦¬ì¦˜ì˜ ë¬¸ì œì  ë¶„ì„ ë° ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ìˆ˜ì •ì‚¬í•­ ì œì‹œ

---

## ğŸš¨ í˜„ì¬ ìƒí™©

20250721_02 ë¬¸ì„œì˜ ê°œì„  ë°©ì•ˆì— ë”°ë¼ ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ë°”ë¼ì¸ ê²€ì¶œì„ êµ¬í˜„í–ˆìœ¼ë‚˜, **ì—¬ì „íˆ ë°”ë¼ì¸ ê²€ì¶œìœ¨ì´ 0%** ìƒíƒœì…ë‹ˆë‹¤.

### êµ¬í˜„ëœ ì£¼ìš” ë³€ê²½ì‚¬í•­
- âœ… ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ê²€ì¶œ ë°©ì‹ ì ìš© (`detect_barlines()`)
- âœ… ì ì‘ì  ì»¤ë„ í¬ê¸° ê³„ì‚° (`get_adaptive_kernel_size()`)
- âœ… í´ëŸ¬ìŠ¤í„°ë§ ê¸°ë°˜ ë°”ë¼ì¸ ìœ„ì¹˜ ê²°ì • (`_cluster_barline_candidates()`)
- âœ… êµì°¨ì  ê²€ì¦ ê¸°ì¤€ ì™„í™” (5ê°œ â†’ 4ê°œ)

---

## ğŸ” êµ¬í˜„ ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### **ë¬¸ì œ 1: ê³¼ë„í•œ í´ëŸ¬ìŠ¤í„°ë§ ìš”êµ¬ì‚¬í•­**

**ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ** (`detect_measure.py:316`):
```python
if len(current_cluster) >= 2:  # Must appear in at least 2 staff lines
    center = int(np.mean(current_cluster))
    clusters.append(center)
```

**ë¬¸ì œì **:
- ë°”ë¼ì¸ì´ ëª¨ë“  ì˜¤ì„ ì—ì„œ ë™ì¼í•œ ê°•ë„ë¡œ ê²€ì¶œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
- ìŠ¤ìº” í’ˆì§ˆ, ì¸ì‡„ ìƒíƒœì— ë”°ë¼ ì¼ë¶€ ì˜¤ì„ ì—ì„œë§Œ ì•½í•˜ê²Œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŒ
- ìµœì†Œ 2ê°œ ìŠ¤íƒœí”„ ë¼ì¸ì—ì„œ ê²€ì¶œë˜ì–´ì•¼ í•œë‹¤ëŠ” ì¡°ê±´ì´ ë„ˆë¬´ ì—„ê²©

**ì¦‰ì‹œ ìˆ˜ì • ë°©ì•ˆ**:
```python
if len(current_cluster) >= 1:  # ë‹¨ì¼ ìŠ¤íƒœí”„ ê²€ì¶œë„ í—ˆìš©
    center = int(np.mean(current_cluster))
    clusters.append(center)
```

### **ë¬¸ì œ 2: ì„ê³„ê°’ ì„¤ì •ì´ ë„ˆë¬´ ë³´ìˆ˜ì **

**ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ** (`detect_measure.py:271`):
```python
threshold = max(0.2, np.mean(normalized[normalized > 0]) * 0.5)
```

**ë¬¸ì œì **:
- í•˜í•œì„  0.2ê°€ ë„ˆë¬´ ë†’ìŒ (20% ì´ìƒë§Œ ê²€ì¶œ)
- ë™ì  ì„ê³„ê°’ë„ í‰ê· ì˜ 50%ë¡œ ë³´ìˆ˜ì 
- ë¯¸ì•½í•œ ë°”ë¼ì¸ ì‹ í˜¸ë„ ë†“ì¹˜ê²Œ ë¨

**ì¦‰ì‹œ ìˆ˜ì • ë°©ì•ˆ**:
```python
threshold = max(0.05, np.mean(normalized[normalized > 0]) * 0.2)  # ëŒ€í­ ì™„í™”
```

### **ë¬¸ì œ 3: ROI í¬ê¸°ê°€ ë¶€ì¡±**

**ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ** (`detect_measure.py:258-259`):
```python
roi_start = max(0, staff_y - 3)
roi_end = min(binary_img.shape[0], staff_y + 4)  # ì´ 7í”½ì…€
```

**ë¬¸ì œì **:
- ë°”ë¼ì¸ì´ ì˜¤ì„ ë³´ë‹¤ ì•½ê°„ ë‘êº¼ìš¸ ìˆ˜ ìˆìŒ
- ìŠ¤ìº” í•´ìƒë„ë‚˜ ì¸ì‡„ í’ˆì§ˆì— ë”°ë¼ ë°”ë¼ì¸ í­ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ
- 7í”½ì…€ ROIê°€ ë°”ë¼ì¸ì˜ ì „ì²´ ì˜ì—­ì„ í¬ì°©í•˜ì§€ ëª»í•  ê°€ëŠ¥ì„±

**ì¦‰ì‹œ ìˆ˜ì • ë°©ì•ˆ**:
```python
roi_start = max(0, staff_y - 5)
roi_end = min(binary_img.shape[0], staff_y + 6)  # 11í”½ì…€ë¡œ í™•ì¥
```

### **ë¬¸ì œ 4: ë””ë²„ê¹… ì •ë³´ ë¶€ì¡±**

**í˜„ì¬ ìƒí™©**:
- ì¤‘ê°„ ê³¼ì •ì—ì„œ ë°œê²¬ë˜ëŠ” í›„ë³´ì˜ ìˆ˜ê°€ ì¶œë ¥ë˜ì§€ ì•ŠìŒ
- ê° ì˜¤ì„ ë³„ projection ìµœëŒ€ê°’ì´ë‚˜ ì„ê³„ê°’ ì •ë³´ê°€ ì—†ìŒ
- ì–´ëŠ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í•˜ëŠ”ì§€ íŒŒì•…ì´ ì–´ë ¤ì›€

**í•„ìš”í•œ ë””ë²„ê·¸ ì¶œë ¥**:
```python
print(f"Staff line {staff_y}: max_projection={np.max(vertical_projection)}, "
      f"threshold={threshold}, candidates_found={len(candidates)}")
```

### **ë¬¸ì œ 5: ì „ì²˜ë¦¬ ë‹¨ê³„ì—ì„œì˜ ì •ë³´ ì†ì‹¤ ê°€ëŠ¥ì„±**

**ì˜ì‹¬ë˜ëŠ” ë¶€ë¶„**:
- `preprocess_image()`ì—ì„œ Otsu ì´ì§„í™”ê°€ ë°”ë¼ì¸ ì •ë³´ë¥¼ ì†ì‹¤ì‹œí‚¬ ìˆ˜ ìˆìŒ
- Gaussian blurê°€ ì–‡ì€ ë°”ë¼ì¸ì„ íë¦¬ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŒ

**ê²€ì¦ í•„ìš”ì‚¬í•­**:
- ì›ë³¸ vs ì „ì²˜ë¦¬ëœ ì´ë¯¸ì§€ì—ì„œ ë°”ë¼ì¸ ì˜ì—­ í”½ì…€ê°’ ë¹„êµ
- ë‹¤ë¥¸ ì´ì§„í™” ë°©ë²• (ê³ ì • ì„ê³„ê°’, ì ì‘ì  ì„ê³„ê°’) ì‹¤í—˜

---

## ğŸš€ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ìˆ˜ì •ì‚¬í•­

### **ìˆ˜ì • 1: ê´€ëŒ€í•œ í´ëŸ¬ìŠ¤í„°ë§** 
```python
# detect_measure.py:316 ìˆ˜ì •
if len(current_cluster) >= 1:  # 1ê°œ ìŠ¤íƒœí”„ì—ì„œë„ í—ˆìš©
```

### **ìˆ˜ì • 2: ì„ê³„ê°’ ëŒ€í­ ì™„í™”**
```python
# detect_measure.py:271 ìˆ˜ì •  
threshold = max(0.05, np.mean(normalized[normalized > 0]) * 0.2)
```

### **ìˆ˜ì • 3: ROI í™•ì¥**
```python
# detect_measure.py:258-259 ìˆ˜ì •
roi_start = max(0, staff_y - 5)
roi_end = min(binary_img.shape[0], staff_y + 6)
```

### **ìˆ˜ì • 4: ë””ë²„ê·¸ ì¶œë ¥ ì¶”ê°€**
```python
# detect_measure.py:275 ì´í›„ì— ì¶”ê°€
if self.debug:
    print(f"Staff {staff_y}: max_proj={np.max(vertical_projection):.3f}, "
          f"threshold={threshold:.3f}, candidates={len(candidates)}")
```

### **ìˆ˜ì • 5: ì „ì²˜ë¦¬ ì‹¤í—˜**
```python
# preprocess_image() ë©”ì„œë“œì— ëŒ€ì²´ ì´ì§„í™” ì˜µì…˜ ì¶”ê°€
def preprocess_image_alternative(self, img):
    """Alternative preprocessing with fixed threshold"""
    # Skip Gaussian blur for thin lines
    _, binary = cv2.threshold(img, 200, 255, cv2.THRESH_BINARY_INV)
    return binary
```

---

## ğŸ§ª ë‹¨ê³„ì  ë””ë²„ê¹… ê³„íš

### **Phase 1: íŒŒë¼ë¯¸í„° ì¡°ì • (ì¦‰ì‹œ ì‹¤í–‰)**
1. ì„ê³„ê°’ì„ 0.05ë¡œ ë‚®ì¶”ê¸°
2. ROIë¥¼ 11í”½ì…€ë¡œ í™•ì¥
3. í´ëŸ¬ìŠ¤í„°ë§ ì¡°ê±´ì„ 1ê°œë¡œ ì™„í™”
4. ë””ë²„ê·¸ ì¶œë ¥ìœ¼ë¡œ ì¤‘ê°„ ê²°ê³¼ í™•ì¸

### **Phase 2: ì „ì²˜ë¦¬ ì‹¤í—˜ (1ì°¨ ìˆ˜ì • í›„)**
1. Gaussian blur ì œê±° ì‹¤í—˜
2. ê³ ì • ì„ê³„ê°’ ì´ì§„í™” ì‹¤í—˜  
3. ì ì‘ì  ì„ê³„ê°’ ì‹¤í—˜
4. ì›ë³¸ vs ì „ì²˜ë¦¬ ì´ë¯¸ì§€ í”½ì…€ê°’ ë¹„êµ

### **Phase 3: ì•Œê³ ë¦¬ì¦˜ ëŒ€ì•ˆ (2ì°¨ ìˆ˜ì • í›„)**
1. Hough Line Transform ê¸°ë°˜ ê²€ì¶œ
2. Template matching ë°©ì‹
3. Contour ê¸°ë°˜ ë°”ë¼ì¸ ê²€ì¶œ
4. ìˆ˜ì§ gradient ê¸°ë°˜ ê²€ì¶œ

---

## ğŸ¯ ì˜ˆìƒ ìˆ˜ì • íš¨ê³¼

### **í˜„ì¬ ìƒíƒœ**
```
Staff line detection: âœ… ì •ìƒ (60+ lines detected)  
Barline candidates: âŒ 0ê°œ ê²€ì¶œ
Clustered barlines: âŒ 0ê°œ ê²€ì¶œ  
Final measures: âŒ 0ê°œ
```

### **Phase 1 ìˆ˜ì • í›„ ì˜ˆìƒ**
```
Barline candidates: ğŸ”„ 10-50ê°œ ê²€ì¶œ ì˜ˆìƒ
Clustered barlines: ğŸ”„ 2-8ê°œ ê²€ì¶œ ì˜ˆìƒ
Detection rate: ğŸ”„ 30-60% ì˜ˆìƒ
```

### **Phase 2 ì™„ë£Œ í›„ ëª©í‘œ**
```
Detection rate: ğŸ¯ 70-85%
False positive rate: ğŸ¯ < 10%
Processing time: ğŸ¯ í˜„ì¬ ëŒ€ë¹„ +20% ì´ë‚´
```

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### **ì¦‰ì‹œ ì‹¤í–‰ (Priority 1)**
- [ ] ì„ê³„ê°’ 0.2 â†’ 0.05ë¡œ ë³€ê²½
- [ ] ROI 7í”½ì…€ â†’ 11í”½ì…€ë¡œ í™•ì¥  
- [ ] í´ëŸ¬ìŠ¤í„°ë§ ì¡°ê±´ 2ê°œ â†’ 1ê°œë¡œ ì™„í™”
- [ ] ë””ë²„ê·¸ ì¶œë ¥ ì¶”ê°€

### **1ì°¨ ê²€ì¦ í›„ ì‹¤í–‰ (Priority 2)**  
- [ ] ì „ì²˜ë¦¬ ë°©ë²• ì‹¤í—˜
- [ ] Gaussian blur ì œê±° í…ŒìŠ¤íŠ¸
- [ ] ê³ ì • ì„ê³„ê°’ ì´ì§„í™” í…ŒìŠ¤íŠ¸

### **2ì°¨ ê²€ì¦ í›„ ì‹¤í–‰ (Priority 3)**
- [ ] ëŒ€ì•ˆ ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
- [ ] ì„±ëŠ¥ ë¹„êµ í…ŒìŠ¤íŠ¸
- [ ] ìµœì  íŒŒë¼ë¯¸í„° íŠœë‹

---

## ğŸ”§ ë‹¤ìŒ ë‹¨ê³„

1. **ì¦‰ì‹œ ìˆ˜ì • ì ìš©** - ìœ„ì˜ 4ê°œ ìˆ˜ì •ì‚¬í•­ì„ ì½”ë“œì— ë°˜ì˜
2. **í…ŒìŠ¤íŠ¸ ì‹¤í–‰** - La Gazza ladra Overtureë¡œ ê²°ê³¼ í™•ì¸  
3. **ë””ë²„ê·¸ ë¡œê·¸ ë¶„ì„** - ì¤‘ê°„ ê³¼ì • ì¶œë ¥ìœ¼ë¡œ ë³‘ëª©ì  íŒŒì•…
4. **ì ì§„ì  ê°œì„ ** - ê²°ê³¼ì— ë”°ë¼ ì¶”ê°€ íŒŒë¼ë¯¸í„° ì¡°ì •
5. **ëŒ€ì•ˆ ë°©ë²• ì¤€ë¹„** - ì—¬ì „íˆ ì‹¤íŒ¨ì‹œ Phase 3 ì•Œê³ ë¦¬ì¦˜ ì ìš©

---

## ğŸ’¡ í•µì‹¬ ê°€ì„¤

**í˜„ì¬ ì‹¤íŒ¨ì˜ ì£¼ìš” ì›ì¸**: ì„ê³„ê°’ì´ ë„ˆë¬´ ë†’ì•„ì„œ ë°”ë¼ì¸ í›„ë³´ê°€ ì• ì´ˆì— ìˆ˜ì§‘ë˜ì§€ ì•Šê³  ìˆìŒ

**ê²€ì¦ ë°©ë²•**: ì„ê³„ê°’ì„ 0.05ë¡œ ë‚®ì¶˜ í›„ ë””ë²„ê·¸ ì¶œë ¥ìœ¼ë¡œ ê° ìŠ¤íƒœí”„ë³„ í›„ë³´ ê°œìˆ˜ í™•ì¸

**ì„±ê³µ ì§€í‘œ**: ê° ìŠ¤íƒœí”„ì—ì„œ ìµœì†Œ 5-10ê°œì˜ í›„ë³´ê°€ ë°œê²¬ë˜ì–´ì•¼ í•¨