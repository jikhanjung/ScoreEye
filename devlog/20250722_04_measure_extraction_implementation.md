# ë§ˆë”” ë‹¨ìœ„ ì´ë¯¸ì§€ ì¶”ì¶œ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025ë…„ 7ì›” 22ì¼  
**ë¬¸ì„œ ëª©ì **: Phase 1.1 ë§ˆë”” ë‹¨ìœ„ ì´ë¯¸ì§€ ë° ë©”íƒ€ë°ì´í„° ìƒì„± ì‹œìŠ¤í…œì˜ ìƒì„¸ êµ¬í˜„ ê³¼ì • ë° ê²°ê³¼ ì •ë¦¬  
**ê´€ë ¨ ë¬¸ì„œ**: `devlog/20250722_03_comprehensive_omr_plan.md` Phase 1.1 êµ¬í˜„

---

## ğŸ¯ êµ¬í˜„ ëª©í‘œ ë‹¬ì„± í˜„í™©

**âœ… ì™„ë£Œëœ ëª©í‘œ**:
1. **ë§ˆë”” ë‹¨ìœ„ ì´ë¯¸ì§€ ìë™ ì¶”ì¶œ**: PDF â†’ í˜ì´ì§€ â†’ ì‹œìŠ¤í…œ ê·¸ë£¹ â†’ ê°œë³„ ë§ˆë”” ì´ë¯¸ì§€
2. **ì •ì œëœ ë©”íƒ€ë°ì´í„° ìƒì„±**: ë¼ë²¨ë§ ë° í›„ì²˜ë¦¬ì— í•„ìˆ˜ì ì¸ ìœ„ì¹˜ ì •ë³´ (BBox, ì˜¤ì„  ì¢Œí‘œ) JSON íŒŒì¼
3. **CLI/GUI í†µí•© ì†”ë£¨ì…˜**: ëª…ë ¹í–‰ ë„êµ¬ì™€ ì‹œê°ì  GUI ì¸í„°í˜ì´ìŠ¤ ëª¨ë‘ ì œê³µ
4. **Consensus ê²€ì¦ ì ìš©**: í›„ë³´ barlinesê°€ ì•„ë‹Œ ê²€ì¦ëœ barlinesë§Œ ì‚¬ìš©í•˜ì—¬ ì •í™•ë„ í™•ë³´

---

## ğŸš€ í•µì‹¬ êµ¬í˜„ ê²°ê³¼

### **1. CLI ë„êµ¬: `extract_measures.py`**

**ê¸°ëŠ¥**: ë°°ì¹˜ ì²˜ë¦¬ìš© ëª…ë ¹í–‰ ë„êµ¬
```bash
# ê¸°ë³¸ ì‚¬ìš©ë²•
python extract_measures.py input.pdf --output output/measures --dpi 300

# íŠ¹ì • í˜ì´ì§€ë§Œ ì²˜ë¦¬
python extract_measures.py input.pdf -p 1 --debug

# í˜ì´ì§€ ë²”ìœ„ ì§€ì •
python extract_measures.py input.pdf -p 1-3
```

**í•µì‹¬ êµ¬í˜„ íŠ¹ì§•**:
- **PyMuPDF ê¸°ë°˜**: poppler ì˜ì¡´ì„± ì œê±°ë¡œ ì„¤ì¹˜ ê°„ì†Œí™”
- **Consensus ê²€ì¦**: `detect_barlines_per_system()` ë©”ì„œë“œë¡œ 80% ì´ìƒ í•©ì˜ëœ barlinesë§Œ ì‚¬ìš©
- **ì‹œìŠ¤í…œ ê·¸ë£¹ ì¸ì‹**: 4ì¤‘ì£¼/ì•™ìƒë¸” ì ìˆ˜ì˜ ì‹œìŠ¤í…œ í´ëŸ¬ìŠ¤í„°ë§ ìë™ ì²˜ë¦¬
- **ìƒëŒ€ ì¢Œí‘œ ë§¤í•‘**: ë§ˆë”” ë‚´ ì˜¤ì„  ìœ„ì¹˜ë¥¼ ìƒëŒ€ ì¢Œí‘œë¡œ ë³€í™˜í•˜ì—¬ ë©”íƒ€ë°ì´í„° ì €ì¥

### **2. GUI í†µí•© ê¸°ëŠ¥: `scoreeye_gui.py` í™•ì¥**

**ìƒˆë¡œ ì¶”ê°€ëœ UI ì»´í¬ë„ŒíŠ¸**:
- **"Show Measure Boxes" ì²´í¬ë°•ìŠ¤**: ì‹¤ì‹œê°„ ë§ˆë”” ê²½ê³„ ë¯¸ë¦¬ë³´ê¸°
- **"Extract Measures" ë²„íŠ¼**: GUIì—ì„œ ì§ì ‘ ë§ˆë”” ì¶”ì¶œ ì‹¤í–‰

**GUI ì›Œí¬í”Œë¡œìš°**:
1. PDF ë¡œë“œ â†’ 2. "Run Detection" â†’ 3. "Show Measure Boxes" ì²´í¬ â†’ 4. ë¯¸ë¦¬ë³´ê¸° í™•ì¸ â†’ 5. "Extract Measures" ì‹¤í–‰

**ì‹œê°ì  ë¯¸ë¦¬ë³´ê¸°**: 
- ë¹¨ê°„ìƒ‰ ì„¸ë¡œì„ : Consensus ê²€ì¦ëœ barlines
- ì´ˆë¡ìƒ‰ ì‚¬ê°í˜•: ì¶”ì¶œë  ë§ˆë”” bounding boxes
- ì‹œìŠ¤í…œë³„ ìƒ‰ìƒ êµ¬ë¶„: ê° ì˜¤ì„  ì‹œìŠ¤í…œì„ ë‹¤ë¥¸ ìƒ‰ìœ¼ë¡œ í‘œì‹œ

---

## ğŸ”§ ìƒì„¸ êµ¬í˜„ ê³¼ì • ë° í•´ê²°í•œ ë¬¸ì œë“¤

### **Phase 1: ì´ˆê¸° CLI ìŠ¤í¬ë¦½íŠ¸ ê°œë°œ**

#### **ë¬¸ì œ 1: poppler ì˜ì¡´ì„± ì´ìŠˆ**
- **ì¦ìƒ**: `pdf2image` ëª¨ë“ˆ ì‚¬ìš© ì‹œ "popplerê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ" ì˜¤ë¥˜
- **í•´ê²°ì±…**: PyMuPDFë¡œ ì™„ì „ ì „í™˜
```python
# Before (pdf2image)
from pdf2image import convert_from_path
images = convert_from_path(pdf_path, dpi=dpi)

# After (PyMuPDF)
import fitz
pdf_document = fitz.open(pdf_path)
page = pdf_document[page_num - 1]
mat = fitz.Matrix(dpi / 72.0, dpi / 72.0)
pix = page.get_pixmap(matrix=mat, alpha=False)
```

#### **ë¬¸ì œ 2: Candidate vs Consensus Barlines í˜¼ë™**
- **ì¦ìƒ**: ëª¨ë“  barline í›„ë³´ë“¤ì´ ì¶”ì¶œë˜ì–´ ê³¼ë„í•œ ë§ˆë”” ë¶„í•  ë°œìƒ
- **ì›ì¸**: `filter_barlines()` ëŒ€ì‹  `detect_barlines_per_system()` ì‚¬ìš© í•„ìš”
- **í•´ê²°ì±…**: Multi-system consensus validation ì ìš©
```python
# WRONG: Candidate barlines ì‚¬ìš©
barlines = detector.filter_barlines(...)

# CORRECT: Consensus validation ì‚¬ìš©  
validated_barlines = detector.detect_barlines_per_system(preprocessed)
```

### **Phase 2: GUI í†µí•© ë° ì‹œê°í™”**

#### **ë¬¸ì œ 3: System vs System Group ê°œë… í˜¼ë™**
- **ì¦ìƒ**: ì˜ëª»ëœ ì‹œìŠ¤í…œì— barlines ì ìš©
- **ì›ì¸**: ê°œë³„ ì‹œìŠ¤í…œ(staff system)ê³¼ ì‹œìŠ¤í…œ ê·¸ë£¹(quartet grouping) êµ¬ë¶„ ì‹¤íŒ¨
- **í•´ê²°ì±…**: ì‹œìŠ¤í…œ ê·¸ë£¹ë³„ barlines ë§¤í•‘ êµ¬í˜„
```python
# ì‹œìŠ¤í…œ ê·¸ë£¹ë³„ë¡œ barlines ë¶„ë¥˜
barlines_by_system_group = {}
for bl_info in barlines_with_systems:
    system_group_idx = bl_info.get('system_idx', 0)  # ì‹œìŠ¤í…œ ê·¸ë£¹ ì¸ë±ìŠ¤
    # ...

# ê° ê·¸ë£¹ì˜ barlinesì„ ê·¸ë£¹ ë‚´ ëª¨ë“  ì‹œìŠ¤í…œì— ì ìš©
for group_idx, system_indices in enumerate(system_groups):
    group_barlines = barlines_by_system_group.get(group_idx, [])
    for sys_idx in system_indices:  # ê·¸ë£¹ ë‚´ ëª¨ë“  ì‹œìŠ¤í…œ
        # ë§ˆë”” ìƒì„±...
```

#### **ë¬¸ì œ 4: JSON Serialization ì˜¤ë¥˜**
- **ì¦ìƒ**: `Object of type int64 is not JSON serializable`
- **ì›ì¸**: NumPy ë°ì´í„° íƒ€ì…ì´ JSONìœ¼ë¡œ ë³€í™˜ë˜ì§€ ì•ŠìŒ
- **í•´ê²°ì±…**: ëª¨ë“  ìˆ˜ì¹˜ ë°ì´í„°ë¥¼ Python ê¸°ë³¸ íƒ€ì…ìœ¼ë¡œ ë³€í™˜
```python
# ëª¨ë“  numpy íƒ€ì…ì„ Python íƒ€ì…ìœ¼ë¡œ ë³€í™˜
"group_index": int(i),
"staff_lines": [{"y": int(y), "index": int(j)} for j, y in enumerate(...)],
"x": int(x), "y": int(y), "width": int(w), "height": int(h)
```

### **Phase 3: ìµœì¢… í†µí•© ë° ê²€ì¦**

#### **êµ¬í˜„ëœ ë©”íƒ€ë°ì´í„° êµ¬ì¡°**
```json
{
  "page_number": 1,
  "page_dimensions": {"width": 2481, "height": 3508},
  "staff_groups": [
    {
      "group_index": 0,
      "staff_lines": [{"y": 553, "index": 0}, ...],
      "y_range": {"min": 553, "max": 634}
    }
  ],
  "system_clusters": [[0, 1, 2, 3], [4, 5, 6, 7], ...],
  "measures": [
    {
      "measure_id": "P1_00_001",
      "filename": "P1_00_001.png", 
      "staff_system_index": 0,
      "system_group_index": 0,
      "bounding_box_on_page": {"x": 0, "y": 533, "width": 385, "height": 121},
      "staff_line_coordinates_in_measure": [
        {"y": 20, "original_y": 553, "staff_index": 0, "group_index": 0}
      ]
    }
  ]
}
```

---

## ğŸ“Š êµ¬í˜„ ì„±ê³¼ ë° í’ˆì§ˆ ì§€í‘œ

### **ì •ëŸ‰ì  ì„±ê³¼**
- **í…ŒìŠ¤íŠ¸ íŒŒì¼**: `La Gazza ladra Overture` 1í˜ì´ì§€ (2481Ã—3508 í”½ì…€)
- **ê²€ì¶œëœ ì‹œìŠ¤í…œ ê·¸ë£¹**: 3ê°œ (ê°ê° 4ê°œ ì‹œìŠ¤í…œìœ¼ë¡œ êµ¬ì„±ëœ 4ì¤‘ì£¼ í¸ì„±)
- **ì¶”ì¶œëœ ë§ˆë”” ìˆ˜**: 36ê°œ (12ê°œ ë§ˆë”” Ã— 3ê°œ ì‹œìŠ¤í…œ ê·¸ë£¹)
- **Consensus ê²€ì¦ìœ¨**: 80% ì´ìƒ í•©ì˜ ìš”êµ¬ (ì„¤ì • ê°€ëŠ¥)

### **í’ˆì§ˆ ê´€ë¦¬**
- **ì •í™•ë„**: GUI ì‹œê°í™”ë¥¼ í†µí•œ ì‹¤ì‹œê°„ ê²€ì¦ ê°€ëŠ¥
- **ì¼ê´€ì„±**: CLIì™€ GUI ë™ì¼í•œ ê²°ê³¼ ë³´ì¥
- **ì¶”ì ì„±**: ëª¨ë“  ì¢Œí‘œ ë³€í™˜ ê³¼ì •ì´ ë©”íƒ€ë°ì´í„°ì— ê¸°ë¡ë¨
- **í™•ì¥ì„±**: ë‹¤ì–‘í•œ ì•…ë³´ í˜•ì‹ (ë…ì£¼, 4ì¤‘ì£¼, ì˜¤ì¼€ìŠ¤íŠ¸ë¼)ì— ëŒ€ì‘

---

## ğŸ—‚ï¸ íŒŒì¼ êµ¬ì¡° ë° ì‚°ì¶œë¬¼

### **ìƒì„±ë˜ëŠ” ë””ë ‰í† ë¦¬ êµ¬ì¡°**
```
output/measures/
â”œâ”€â”€ metadata.json                    # ì „ì²´ í”„ë¡œì íŠ¸ ë©”íƒ€ë°ì´í„°
â””â”€â”€ page_01/
    â”œâ”€â”€ metadata.json               # í˜ì´ì§€ë³„ ìƒì„¸ ë©”íƒ€ë°ì´í„°
    â”œâ”€â”€ P1_00_001.png              # ì‹œìŠ¤í…œ 0, ë§ˆë”” 1
    â”œâ”€â”€ P1_00_002.png              # ì‹œìŠ¤í…œ 0, ë§ˆë”” 2
    â”œâ”€â”€ P1_01_001.png              # ì‹œìŠ¤í…œ 1, ë§ˆë”” 1
    â””â”€â”€ ...                        # ì´ 36ê°œ ë§ˆë”” ì´ë¯¸ì§€
```

### **í•µì‹¬ ì½”ë“œ ëª¨ë“ˆ**
- **`extract_measures.py`**: ë©”ì¸ CLI ë„êµ¬ (311ì¤„)
- **`scoreeye_gui.py`**: GUI í™•ì¥ (`generate_measure_boxes()`, `extract_measures()` ë©”ì„œë“œ ì¶”ê°€)
- **ì¶œë ¥ íŒŒì¼ ëª…ëª… ê·œì¹™**: `P{page}_{system:02d}_{measure:03d}.png`

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„ ì¤€ë¹„ ì™„ë£Œ

### **Phase 1.2 ë¼ë²¨ë§ì„ ìœ„í•œ ê¸°ë°˜ ë§ˆë ¨**
1. **ê³ í’ˆì§ˆ ë§ˆë”” ì´ë¯¸ì§€**: ê°œë³„ ë§ˆë””ë³„ë¡œ ì •ì œëœ ì´ë¯¸ì§€ ì¤€ë¹„ ì™„ë£Œ
2. **ì •í™•í•œ ë©”íƒ€ë°ì´í„°**: ì˜¤ì„  ìœ„ì¹˜, ì‹œìŠ¤í…œ ì •ë³´ ë“± ë¼ë²¨ë§ì— í•„ìš”í•œ ëª¨ë“  ì •ë³´ ì œê³µ
3. **ë°°ì¹˜ ì²˜ë¦¬ ëŠ¥ë ¥**: ë‹¤ì–‘í•œ ì•…ë³´ PDFì— ëŒ€í•œ ëŒ€ëŸ‰ ë°ì´í„°ì…‹ ìƒì„± ê°€ëŠ¥
4. **í’ˆì§ˆ ê²€ì¦ ë„êµ¬**: GUIë¥¼ í†µí•œ ì‹¤ì‹œê°„ ê²€ì¦ ë° ì‹œê°ì  í™•ì¸ ê°€ëŠ¥

### **Roboflow ì—°ë™ ì¤€ë¹„**
- **ì´ë¯¸ì§€ í¬ë§·**: PNG í˜•ì‹ìœ¼ë¡œ í‘œì¤€í™”
- **ë©”íƒ€ë°ì´í„° í˜¸í™˜ì„±**: í–¥í›„ YOLO í•™ìŠµì— í•„ìš”í•œ ëª¨ë“  ì •ë³´ í¬í•¨
- **ì ì§„ì  í™•ì¥**: Level 1 í´ë˜ìŠ¤ë¶€í„° ì‹œì‘ ê°€ëŠ¥í•œ êµ¬ì¡°

---

## ğŸ ê²°ë¡ 

**Phase 1.1 ë§ˆë”” ë‹¨ìœ„ ì´ë¯¸ì§€ ë° ë©”íƒ€ë°ì´í„° ìƒì„±** ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 

- âœ… **CLI/GUI ë“€ì–¼ ì¸í„°í˜ì´ìŠ¤** êµ¬í˜„ìœ¼ë¡œ ê°œë°œ ë° í”„ë¡œë•ì…˜ í™˜ê²½ ëª¨ë‘ ì§€ì›
- âœ… **Consensus ê²€ì¦ ì‹œìŠ¤í…œ** ì ìš©ìœ¼ë¡œ ë†’ì€ ì •í™•ë„ í™•ë³´  
- âœ… **ì‹œìŠ¤í…œ ê·¸ë£¹ ì¸ì‹** êµ¬í˜„ìœ¼ë¡œ ë³µì¡í•œ ì•™ìƒë¸” ì•…ë³´ ì²˜ë¦¬ ê°€ëŠ¥
- âœ… **ì™„ì „í•œ ë©”íƒ€ë°ì´í„°** ìƒì„±ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ YOLO í•™ìŠµ ì¤€ë¹„ ì™„ë£Œ

ì´ì œ ë‹¤ìŒ ë‹¨ê³„ì¸ **Phase 1.2 ì ì§„ì  í´ë˜ìŠ¤ ë¼ë²¨ë§** ë° **Phase 2 YOLO ëª¨ë¸ í•™ìŠµ**ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆëŠ” ê²¬ê³ í•œ ê¸°ë°˜ì´ ë§ˆë ¨ë˜ì—ˆìŠµë‹ˆë‹¤.

---

**êµ¬í˜„ ì™„ë£Œì¼**: 2025ë…„ 7ì›” 22ì¼  
**ë‹¤ìŒ ë§ˆì¼ìŠ¤í†¤**: Roboflow í”„ë¡œì íŠ¸ ì„¤ì • ë° Level 1 í´ë˜ìŠ¤ ë¼ë²¨ë§ ì‹œì‘  
**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: Phase 1.2 ì™„ë£Œê¹Œì§€ 1ì£¼ì¼