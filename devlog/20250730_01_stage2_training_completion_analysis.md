# Stage 2 Training Completion Analysis and Key Insights

작성일: 2025-07-30  
작성자: ScoreEye Development Team

## 1. Executive Summary

Stage 2 YOLOv8s 훈련이 100 에폭을 성공적으로 완주하였습니다. 이번 분석에서는 훈련 완료 결과와 음표 검출 실패 원인에 대한 올바른 이해, 그리고 Stage 3를 위한 실질적 개선 방향을 정리합니다.

## 2. Stage 2 훈련 최종 결과

### 2.1 성능 지표 (100 에폭 완료)
```
최종 성능:
- mAP@50: 0.764 (76.4%)
- mAP@50-95: 0.594 (59.4%)  
- Precision: 0.924 (92.4%)
- Recall: 0.665 (66.5%)

성능 향상 추이:
- 시작 (1 에폭): mAP50 0.315
- 최고점 (96 에폭): mAP50 0.763
- 종료 (100 에폭): mAP50 0.764
- 총 향상: +44.9%
```

### 2.2 훈련 안정성
- **메모리 사용**: 평균 3.9GB, 최대 6.76GB (11GB 한계 내)
- **배치 크기 1**: 안정적이지만 GPU 활용도 35%로 비효율적
- **에폭당 시간**: 약 32분 (총 53시간 소요)
- **수렴성**: 90 에폭 이후 성능 포화 상태

## 3. 음표 검출 실패 원인 재분석

### 3.1 기존 잘못된 가설
❌ **"clefG 누락이 음표 검출에 영향"**
- Object Detection은 각 객체를 독립적으로 검출
- clefG 유무와 noteheadBlack 검출은 무관
- 음악적 맥락(context)를 사용하지 않음

### 3.2 실제 원인 분석

#### **3.2.1 YOLOv8s 모델 용량 한계 (주요 원인)**
```python
YOLOv8s: 11.2M 파라미터
- 작은 객체 검출 어려움 (augmentationDot, flag 등)
- 복잡한 특징 패턴 학습 부족
- 고밀도 객체 환경에서 성능 저하
```

#### **3.2.2 클래스 복잡성으로 인한 학습 리소스 분산**
```
Stage 2 실제 클래스 (45개):
✅ 포함: beam, tie, slur (원래 제외 예정이었으나 ID 매핑 오류로 포함)
❌ 제외: clefG (원래 포함되어야 했으나 ID 매핑 오류로 제외)

문제점:
- beam, tie, slur: 얇고 곡선적이어서 검출 극도로 어려움
- 모델이 이런 어려운 클래스 학습에 과도한 리소스 소모
- 기본 음표(noteheadBlack 등) 학습 품질 저하
```

#### **3.2.3 신뢰도 임계값 필터링**
```
테스트 설정: conf_threshold = 0.25
- 작은 음표들은 낮은 신뢰도(0.15-0.24)로 검출
- 임계값 아래로 필터링되어 결과에서 제외
- 특히 augmentationDot, 작은 flag들이 많이 누락
```

## 4. Stage 2 성능 한계 정량 분석

### 4.1 클래스별 성능 추정
```
예상 클래스별 검출 성능:
- noteheadBlack: 80-85% (상대적으로 큰 객체)
- augmentationDot: 40-50% (매우 작음)
- flag8th/16th: 60-70% (작고 얇음)
- beam/tie/slur: 10-20% (거의 검출 불가)
- accidental: 75-80% (중간 크기)
- rest: 70-75% (명확한 패턴)
```

### 4.2 전체 mAP 0.764의 의미
- 실제로는 **핵심 음표 클래스는 80% 이상** 검출 가능
- 어려운 클래스들(beam, tie, slur)이 전체 평균을 하향 조정
- **YOLOv8s + 잘못된 클래스 구성**을 고려하면 합리적 성능

## 5. 메모리 사용 패턴 분석

### 5.1 배치 크기별 실제 경험
```
배치 1 (실제 사용):
- 평균 메모리: 3.9GB
- 최대 메모리: 6.76GB  
- 안정성: 매우 높음
- GPU 활용도: 35% (비효율적)
- 에폭당 시간: 32분

배치 2 (테스트 결과):
- 평균 메모리: 7-8GB (추정)
- 간헐적 스파이크: 11GB+ (메모리 초과)
- 문제 에폭: 전체의 10-15%
- 문제 발생 시: 4시간/에폭
```

### 5.2 YOLOv8m 메모리 예상
```
YOLOv8m (25.9M 파라미터):
- 배치 1 예상: 평균 6-7GB, 최대 10-11GB
- 11GB 한계선 근접하지만 안전할 것으로 예상
- 메모리 효율성: 60-70% (현재 35%에서 개선)
```

## 6. Stage 3 개선 전략 수정

### 6.1 핵심 개선 포인트
1. **모델 용량 증가**: YOLOv8s → YOLOv8m (2.3배)
2. **클래스 정리**: 어려운 5개 제외, clefG 포함
3. **학습 집중**: 45개 → 45개 (정확한 클래스로)

### 6.2 예상 성능 향상
```
Stage 2 → Stage 3 예상 개선:
- 전체 mAP50: 0.764 → 0.82-0.85
- 작은 객체 검출률: 40-50% → 70-80%
- 핵심 음표 검출률: 80% → 90%+
- 전체적 안정성: 높음 → 매우 높음
```

### 6.3 실질적 OMR 성능 기대치
```
음악 기호 검출 완성도:
- 음자리표: 95%+ (clefG 포함으로 완전)
- 음표 머리: 90%+ (모델 용량 증가 효과)
- 쉼표: 85%+ (명확한 패턴)
- 임시표: 85%+ (적당한 크기)
- 아티큘레이션: 80%+ (작지만 명확)
- 다이나믹: 75%+ (텍스트성 기호)
```

## 7. 훈련 시간 최적화 분석

### 7.1 배치 크기 vs 시간 효율성
```
Stage 2 경험:
- 배치 1: 일정하지만 느림 (32분/에폭)
- 배치 2: 평균적으로 빠르지만 간헐적 지연

Stage 3 권장 전략:
- YOLOv8m + 배치 1: 안정성 최우선
- 예상 시간: 45-50분/에폭
- 100 에폭: 약 75-85시간 (3-4일)
```

### 7.2 조기 종료 전략
```
Early Stopping 설정:
- patience=20 (20 에폭 연속 개선 없으면 종료)
- 예상 실제 훈련: 60-80 에폭
- 실제 소요 시간: 45-65시간 (2-3일)
```

## 8. 데이터 증강 효과 분석

### 8.1 Stage 2에서 사용된 증강
```python
# 음악 기호에 적합한 보수적 증강
hsv_h=0.01,      # 색조 변화 최소화 ✓
degrees=0.0,     # 회전 금지 (방향 중요) ✓
flipud=0.0,      # 상하 뒤집기 금지 ✓
mosaic=0.0,      # 메모리 절약 ✓
```

### 8.2 Stage 3 증강 전략 유지
- 현재 설정이 음악 기호에 최적화되어 있음
- 추가 변경 불필요
- 안정성과 정확도의 균형점

## 9. Stage 2에서 얻은 핵심 교훈

### 9.1 기술적 교훈
1. **클래스 ID 매핑의 중요성**: 숫자 ID만으로는 실수 빈발
2. **모델 용량과 성능의 관계**: 복잡한 데이터셋은 큰 모델 필요
3. **메모리 관리의 중요성**: 안정성이 속도보다 중요
4. **Object Detection의 특성 이해**: Context 정보 사용 안 함

### 9.2 프로젝트 관리 교훈
1. **단계적 접근의 효과**: Stage별 문제 격리 및 해결
2. **검증 시스템의 필요성**: 전처리 후 클래스 이름 확인 필수
3. **로깅의 중요성**: 상세한 기록으로 문제 원인 파악 가능

## 10. Stage 3 성공을 위한 체크리스트

### 10.1 전처리 검증
- [ ] clefG (ID: 6) 포함 확인
- [ ] beam (ID: 122), tie (ID: 123), slur (ID: 121) 제외 확인
- [ ] 총 45개 클래스 정확성 검증
- [ ] YAML 파일 경로 및 클래스 이름 확인

### 10.2 훈련 설정
- [ ] YOLOv8m.pt 모델 사용
- [ ] 배치 크기 1 (안정성 최우선)
- [ ] imgsz 1024 (메모리 안정성)
- [ ] mosaic 0.0 (메모리 절약)
- [ ] patience 20 (조기 종료)

### 10.3 모니터링 포인트
- [ ] 메모리 사용량 (11GB 이하 유지)
- [ ] 첫 10 에폭 손실 안정성
- [ ] mAP 향상 추이 (0.82+ 목표)
- [ ] 작은 객체 검출률 개별 확인

## 11. 결론

Stage 2는 여러 문제에도 불구하고 YOLOv8 파이프라인의 안정성을 입증했습니다. 특히 clefG 누락이 Object Detection 성능에 직접적 영향을 미치지 않는다는 점을 이해함으로써, 실제 성능 저하 원인을 모델 용량과 클래스 복잡성으로 정확히 식별할 수 있었습니다.

Stage 3에서는 이러한 교훈을 바탕으로:
1. **YOLOv8m으로 모델 용량 2.3배 증가**
2. **올바른 클래스 구성으로 학습 효율성 향상**
3. **검증된 안정적 설정으로 훈련 신뢰성 확보**

이를 통해 mAP 0.82-0.85 달성과 실용적 OMR 시스템 구축이 가능할 것으로 예상됩니다.

---

**다음 단계**: Stage 3 전처리 완료 후 YOLOv8m 훈련 즉시 시작  
**예상 완료**: 2025-08-02 (3-4일 후)  
**목표 성능**: mAP@50 > 0.82, 실용적 음악 기호 검출 시스템 완성